#!/bin/bash
# ZERO-TRACE POLICY: Pre-commit hook
# Blocks absolute paths and secret patterns

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "üîç Running pre-commit security checks..."

FAILED=0

# Get staged files
STAGED_DIFF=$(git diff --cached --diff-filter=ACMR 2>/dev/null || true)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úì No staged files to check${NC}"
    exit 0
fi

# A) BLOCK ABSOLUTE PATHS
echo -n "  Checking for absolute paths... "
if echo "$STAGED_DIFF" | grep -E '(/Users/|/home/|C:\\Users\\|/private/|/var/|\\AppData\\|[A-Z]:\\)' > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found absolute paths in staged changes!"
    echo "   Matches:"
    echo "$STAGED_DIFF" | grep -E '(/Users/|/home/|C:\\Users\\|/private/|/var/|\\AppData\\|[A-Z]:\\)' | head -5
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# B) BLOCK SECRET PATTERNS
echo -n "  Checking for secret patterns... "
if echo "$STAGED_DIFF" | grep -iE '(api|secret|token|password|key)\s*[:=]' > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found potential secrets in staged changes!"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for private keys
echo -n "  Checking for private keys... "
if echo "$STAGED_DIFF" | grep -E '-----BEGIN (PRIVATE KEY|RSA PRIVATE KEY|EC PRIVATE KEY)-----' > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found private key in staged changes!"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for sensitive files
echo -n "  Checking for sensitive files... "
SENSITIVE_PATTERNS="\.p8$|\.p12$|\.cer$|\.mobileprovision$|\.jks$|\.keystore$|GoogleService-Info\.plist$|google-services\.json$"
if echo "$STAGED_FILES" | grep -iE "$SENSITIVE_PATTERNS" > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found sensitive files in staged changes!"
    echo "$STAGED_FILES" | grep -iE "$SENSITIVE_PATTERNS"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for service account markers
echo -n "  Checking for service account JSON... "
if echo "$STAGED_DIFF" | grep -E '"type"\s*:\s*"service_account"' > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found service account JSON in staged changes!"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

if [ $FAILED -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå Pre-commit checks FAILED. Commit blocked.${NC}"
    echo "   Fix the issues above before committing."
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All pre-commit checks passed${NC}"
exit 0
