#!/bin/bash
# ZERO-TRACE POLICY: Pre-push hook
# Final verification before pushing to remote

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "üîç Running pre-push security checks..."

FAILED=0

# Get all tracked files
ALL_FILES=$(git ls-files 2>/dev/null || true)

# A) BLOCK ABSOLUTE PATHS in entire codebase
echo -n "  Scanning codebase for absolute paths... "
if git grep -l -E '(/Users/|/home/|C:\\Users\\|/private/|/var/|\\AppData\\|[A-Z]:\\)' -- '*.dart' '*.swift' '*.kt' '*.java' '*.plist' '*.xml' '*.json' '*.yaml' '*.yml' 2>/dev/null | grep -v '.gitignore' > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found absolute paths in codebase!"
    git grep -l -E '(/Users/|/home/|C:\\Users\\|/private/|/var/|\\AppData\\|[A-Z]:\\)' -- '*.dart' '*.swift' '*.kt' '*.java' '*.plist' '*.xml' '*.json' '*.yaml' '*.yml' 2>/dev/null | grep -v '.gitignore' | head -10
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# B) BLOCK SECRET PATTERNS in entire codebase
echo -n "  Scanning codebase for secrets... "
if git grep -l -iE '(api_key|secret_key|private_key|password)\s*[:=]\s*["\047][^"\047]+["\047]' -- '*.dart' '*.swift' '*.kt' '*.java' '*.plist' '*.xml' '*.json' '*.yaml' '*.yml' 2>/dev/null > /dev/null 2>&1; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found potential hardcoded secrets!"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for sensitive files in repo
echo -n "  Checking for sensitive files in repo... "
SENSITIVE_FILES=$(git ls-files | grep -iE '\.(p8|p12|cer|mobileprovision|jks|keystore)$' 2>/dev/null || true)
if [ -n "$SENSITIVE_FILES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found sensitive files in repository!"
    echo "$SENSITIVE_FILES"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for Google service files
echo -n "  Checking for Google service files... "
GOOGLE_FILES=$(git ls-files | grep -iE '(GoogleService-Info\.plist|google-services\.json)$' 2>/dev/null || true)
if [ -n "$GOOGLE_FILES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "‚ùå Found Google service files in repository!"
    echo "$GOOGLE_FILES"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

if [ $FAILED -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå Pre-push checks FAILED. Push blocked.${NC}"
    echo "   Fix the issues above before pushing."
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All pre-push checks passed${NC}"
exit 0
